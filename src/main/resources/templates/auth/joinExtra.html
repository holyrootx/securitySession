<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.tailwindcss.com"></script>
    <title>추가 정보 입력</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { background: #f7fafc; }
        .form-box { background: #fff; border-radius: 1rem; padding: 2rem; box-shadow: 0 2px 16px rgba(0,0,0,0.07); }
        label { font-weight: 600; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">
<form id="joinExtraForm" action="/join/extra" method="POST" class="form-box w-full max-w-md space-y-5">
    <h2 class="text-2xl font-bold text-center mb-6">추가 정보 입력</h2>

    <!-- 소셜 로그인 시, 이미 알고 있는 값은 readonly 처리 가능 -->
    <div>
        <label for="email">아이디(이메일)</label>
        <input id="email" name="email" type="email" required class="w-full border p-2 rounded focus:outline-none text-gray-500 bg-gray-100 cursor-not-allowed" readonly th:value="${email}">
        <p id="email-error-message" class="text-red-600" ></p>
    </div>
    <div>
        <label for="name">이름</label>
        <input id="name" name="name" type="text" required class="w-full border p-2 rounded" th:value="${name}" placeholder="이름 입력">
        <p id="name-error-message" class="text-red-600" ></p>
    </div>
    <div>
        <label for="nickname">닉네임</label>
        <input id="nickname" name="nickname" type="text" required class="w-full border p-2 rounded" placeholder="닉네임 입력">
        <p id="nickname-error-message" class="text-red-600" ></p>
    </div>
    <div>
        <label for="phoneNumber">전화번호</label>
        <input id="phoneNumber" name="phoneNumber" type="tel" required class="w-full border p-2 rounded" placeholder="010-1234-5678">
        <p id="phoneNumber-error-message" class="text-red-600" ></p>
    </div>
    <!-- 필요시 비밀번호 입력 추가 -->
    <!-- <div>
        <label for="password">비밀번호</label>
        <input id="password" name="password" type="password" required class="w-full border p-2 rounded" placeholder="비밀번호">
    </div> -->

    <button id="joinBtn" type="submit" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">제출</button>
</form>
<div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white p-6 rounded shadow-lg text-center w-80">
        <p class="text-lg mb-4">회원가입을 요청하시겠습니까?</p>
        <div class="flex justify-center gap-4">
            <button onclick="confirmJoin()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">확인</button>
            <button onclick="hideModal()" class="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400">취소</button>
        </div>
    </div>
</div>
<div id="toast-container" class="fixed inset-x-0 top-0 z-50 space-y-3 text-center"></div>
<script>
    function showModal() {
        document.getElementById("confirmModal").classList.remove("hidden");
    }
    function hideModal() {
        document.getElementById("confirmModal").classList.add("hidden");
    }
    function confirmJoin() {
        hideModal();
        join();
    }
    const form = document.getElementById("joinExtraForm");

    document.getElementById("joinBtn").addEventListener("click",(e)=>{
        e.preventDefault();
        showModal();
    })
    

    async function join(){
        const form = document.getElementById("joinExtraForm");
        const formData = new FormData(form);
        const data = {};

        formData.forEach((value,key) => {
            data[key] = value;

        });

        const res = await fetch(`/auth/validate/extra`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
        });

        const result = await res.json();
        if (result.code === 'OK') {
            showToast("회원가입 절차 진행 중", 'success',3000);

            const adminRes = await fetch(`/auth/joinExtra`,{
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(data)
            });

            const createResult = await adminRes.json();
            
            if(createResult.code === "OK"){
                showToast("계정 생성 절차 진행 중", 'success',3000);

                setTimeout(() => {
                    window.location.href = `/main`;
                }, 1500);
            } else if(createResult.code === "UVF"){
                showToast(createResult.message || '생성 중 오류 발생','error',3000);

                const p = document.getElementById(`username-error-message`);
                p.textContent = createResult.message;
            } else if(createResult.code === "PVF"){
                showToast(createResult.message || '생성 중 오류 발생','error',3000);
                const p = document.getElementById(`phoneNumber-error-message`);
                p.textContent = createResult.message;
            } else{
                showToast(createResult.message || '생성 중 오류 발생','error',3000);
            }



        } else {
            showToast(result.message || '생성 중 오류 발생','error',3000);
            // 1) 기존 에러 메시지 모두 초기화
            ['email','name','username','phoneNumber'].forEach(field => {
                const p = document.getElementById(`${field}-error-message`);
                
                if (p) {
                    p.textContent = ''
                };

            });

            // 2) error 배열 순회, 같은 필드에 메시지 여러 개면 첫 번째만 출력
            result.data.forEach(err => {
                const p = document.getElementById(`${err.field}-error-message`);

                if (p && !p.textContent) {
                    p.textContent = err.message;
                }
            });

        }
    }

    function showToast(message, type = 'success', duration = 3000) {

        const container = document.getElementById("toast-container");

        const colors = {
            success: {
                bg: "bg-green-500",
                icon: "✅"
            },
            error: {
                bg: "bg-red-500",
                icon: "❌"
            }
        };

        const toast = document.createElement("div");
        toast.className = `flex items-center text-white px-4 py-2 rounded shadow-lg ${colors[type].bg} animate-slide-in-right`;
        toast.innerHTML =
        `<span class="mr-2">${colors[type].icon}</span>
        <span>${message}</span>`;

        container.appendChild(toast);

        setTimeout(() => {
            toast.classList.remove("animate-slide-in-right");
            toast.classList.add("animate-fade-out");

            setTimeout(() => container.removeChild(toast), 5000);

        }, duration);
    }

</script>
</body>
</html>
